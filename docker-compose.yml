version: "3.7"

services:
  # Railsのサンプルアプリケーション
  app:
    build: .

    # プロセスが正しく後始末されるようにする
    init: true

    ports:
      - "3000:3000"

    volumes:
      - .:/app
      # /app/node_modulesに匿名ボリュームをマウントする
      # node_modulesはイメージにあるものを使う
      - /app/node_modules

    # for pry-byebug
    # docker attachできるように標準入力が仮想端末に繋がった状態にしておく
    stdin_open: true
    tty: true

    environment:
      # webpackのアセットをwebpack-dev-serverから取得する
      - WEBPACKER_DEV_SERVER_HOST=webpack
      - WEBPACKER_DEV_SERVER_PUBLIC=localhost:3035

  webpack:
    build: .
    # Rubyのbinstubを経由してサーバーを実行するようにしている
    command: ruby ./bin/webpack-dev-server
    ports:
      - "3035:3035"
    environment:
      - WEBPACKER_DEV_SERVER_HOST=0.0.0.0
    volumes:
      - .:/app
      # node_modulesはイメージにあるものを使う
      - /app/node_modules
